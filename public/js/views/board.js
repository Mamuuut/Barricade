// Generated by CoffeeScript 1.3.3
(function() {

  define(['backbone', 'GameModel'], function(Backbone, GameModel) {
    var BoardView, CELL_HEIGHT, CELL_WIDTH, DICE_CLASSES, MARGIN;
    CELL_WIDTH = 30;
    CELL_HEIGHT = 30;
    MARGIN = 45;
    DICE_CLASSES = ['one', 'two', 'three', 'four', 'five', 'six'];
    BoardView = Backbone.View.extend({
      el: $("#board_container"),
      boardSocket: null,
      hoveredCell: null,
      cells: {},
      pawns: {},
      initialize: function() {
        this.playerid = this.options.playerid;
        return this.boardSocket = io.connect('/game_list');
      },
      events: {
        "click .back": "backToGameList",
        "click .pawn.hoverable": "pawnSelected"
      },
      render: function() {
        this.drawCells();
        return this.drawPawns();
      },
      drawCells: function() {
        var _this = this;
        return _.each(GameModel.BOARD, function(line, j) {
          return _.each(line, function(i) {
            var cellClass, posStr;
            cellClass = GameModel.getCellClass(i + ":" + j);
            posStr = i + ':' + j;
            return _this.cells[posStr] = _this.drawOne(i, j, cellClass);
          });
        });
      },
      drawPawns: function() {
        var _this = this;
        return _.each(this.model.get('pawns'), function(pawns, pawnClass) {
          return _.each(pawns, function(posStr) {
            var pos;
            pos = posStr.split(':');
            return _this.pawns[posStr] = _this.drawOne(pos[0], pos[1], 'pawn ' + pawnClass);
          });
        });
      },
      drawOne: function(i, j, cellClass) {
        var cell, x, y;
        x = MARGIN + CELL_WIDTH * i;
        y = MARGIN + CELL_WIDTH * j;
        cell = $('<div/>');
        cell.addClass('cell');
        cell.addClass(cellClass);
        cell.css({
          width: CELL_WIDTH + 'px',
          height: CELL_HEIGHT + 'px',
          left: x + 'px',
          top: y + 'px'
        });
        this.$('#board').append(cell);
        cell.data('pos', i + ':' + j);
        return cell;
      },
      updatePlayerTurn: function() {
        var color, diceClass;
        color = GameModel.COLORS[this.model.get('turn').player];
        this.$('#turn').removeClass();
        this.$('#turn').addClass(color);
        diceClass = DICE_CLASSES[this.model.get('turn').dice];
        this.$('#dice').removeClass();
        this.$('#dice').addClass(diceClass);
        this.$('.pawn').removeClass('hoverable');
        return this.$('.pawn.' + color).addClass('hoverable');
      },
      play: function(game) {
        this.$('.pawn').removeClass('selected');
        this.$('.cell').removeClass('target');
        this.model = game;
        this.render();
        return this.updatePlayerTurn();
      },
      pawnSelected: function(event) {
        var moves, pawn,
          _this = this;
        this.$('.pawn').removeClass('selected');
        this.$('.cell').removeClass('target');
        pawn = $(event.currentTarget);
        pawn.addClass('selected');
        moves = this.model.getMoves(pawn.data('pos'));
        return _.each(moves, function(posStr) {
          return _this.cells[posStr].addClass('target');
        });
      },
      backToGameList: function() {
        return this.trigger('back');
      }
    });
    return BoardView;
  });

}).call(this);
